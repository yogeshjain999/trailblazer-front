<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"/>
    <title>Endpoint - Trailblazer</title>
    <meta content="width=device-width,initial-scale=1" name="viewport"/>
    
    
    <link rel="stylesheet" href="/assets/tailwind-a6d826333e13236f7073580d8ef10b73a06a0356d808f6e415e22ba9b2a3de33.css" />
<link rel="stylesheet" href="/assets/inter-font-8c3e82affb176f4bca9616b838d906343d1251adc8408efe02cf2b1e4fcf2bc4.css" />
    <link rel="stylesheet" href="/assets/application-9915db70b6ec78b594924b5260f77917dbde4dfa05406926e8065c51138be1c6.css" />
    <script>pageIdentifier = "docs";</script>
    <script type="importmap" data-turbo-track="reload">{
  "imports": {
    "application": "/assets/application-840139e27b33cd120687852d38911c11e91b076728d40aca3b48439d857c60ad.js",
    "anchor-js": "/assets/anchor-js-821952d04abcd941bb3541822cd1c1f0234e5168bef1f9b2a050868af608aa5a.js",
    "navigations": "/assets/navigations-27f57ba888008b48256d2635e15bd2f0be7a039b32c8e84140da87596cbf9547.js",
    "docsearch": "/assets/docsearch-ec78641e626432933b5c9f60c1f9de8cf1c15c4446aa565f6b185495eed4cdb0.js",
    "highlight.js/lib/core": "/assets/highlight.js--lib--core-d83dc99104442fb344c757a56d28fa888edee01ed7e6dad88a445f7c7ec6d4c9.js",
    "highlight.js/lib/languages/ruby": "/assets/highlight.js--lib--languages--ruby-f74e4cf7cb12132c4f16865b466beac81cd62a84a8119ebf005060b9d5945175.js",
    "jquery": "/assets/jquery-9292661fe0d8c5ef2ef35f5ca64d541d70c87e9f6d7f2716d646591a295b7f36.js",
    "jquery.parallax-scroll": "/assets/jquery.parallax-scroll-a50d2125650d18a234bc9a3eea0a0f1c40871f3ccfba877d0eae70e690955825.js",
    "@docsearch/js": "https://cdn.jsdelivr.net/npm/@docsearch/js@3.5.2/dist/umd/index.min.js"
  }
}</script>
<link rel="modulepreload" href="/assets/application-840139e27b33cd120687852d38911c11e91b076728d40aca3b48439d857c60ad.js">
<link rel="modulepreload" href="/assets/anchor-js-821952d04abcd941bb3541822cd1c1f0234e5168bef1f9b2a050868af608aa5a.js">
<script src="/assets/es-module-shims.min-4ca9b3dd5e434131e3bb4b0c1d7dff3bfd4035672a5086deec6f73979a49be73.js" async="async" data-turbo-track="reload"></script>
<script type="module">import "application"</script>

    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  </head>
  <body>
    <nav class=" text-base z-[50] top-0 absolute w-full lg:h-[5.5rem] lg:px-[5.6rem] py-3 lg:flex lg:justify-between lg:items-center bg-white sticky" id="navbar">
  <a href="/2.1" class="block shrink-0 w-fit mx-auto lg:mx-0">
    <img class="w-40 lg:my-0" src="/assets/logo_blue_ruby-e87334a67ff20033fae8c8d2c07e549b5f1faa9b75bb07fbb2ff9d1c0dfef6e7.svg" />
  </a>
  <div class="lg:hidden absolute right-4 top-2 flex w-9 h-9 items-center" id="hamburgerIcon">
    <div class="pointer-events-none w-full h-0.5 bg-blue transition-all duration-150
                  before:content-[''] before:absolute before:w-full before:h-0.5 before:bg-blue before:-translate-y-2.5 before:transition-all before:duration-150
                  after:content-[''] after:absolute after:w-full after:h-0.5 after:bg-blue after:translate-y-2.5 after:transition-all after:duration-150"></div>
  </div>
  <div class="lg:hidden flex flex-col text-center hidden" id="navList">
    <div class="lg:absolute flex flex-col mt-15 gap-10 uppercase">
      <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="/2.1/docs/trailblazer">Documentation</a>
      <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="https://dev.to/trailblazer">Blog</a>
      <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="/2.1/about.html">About</a>
      
      <!-- <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="/2.1/pro.html">PRO</a> -->
      <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="https://trailblazer.zulipchat.com">Chat with us</a>
    </div>
  </div>
  <div class="lg:flex hidden gap-10 items-center">
    <div class="flex gap-7">
      <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold underline decoration-[5px] underline-offset-[15px] decoration-purple hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="/2.1/docs/trailblazer">Documentation</a>
      <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="https://dev.to/trailblazer">Blog</a>
      <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="/2.1/about.html">About</a>
      <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="/2.0/">→ 2.0</a>
      
      <!-- <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="/2.1/pro.html">PRO</a> -->
    </div>

    <a class="base-button text-base w-[12.5rem] h-[3.25rem] bg-light-purple text-blue hover:text-white hover:bg-purple" href="https://trailblazer.zulipchat.com">Chat with us</a>
  </div>
</nav>

<section>
  <div class="lg:hidden bg-bg-blue text-white fixed left-0 top-20 pr-1 py-3 rounded-r" id="sideNavShowButton" style="writing-mode: vertical-rl; text-orientation: upright;">
    Chapters
  </div>
  <div class="lg:flex">
    <nav class="bg-bg-blue w-screen h-screen fixed top-0 z-20 right-[100vw] overflow-y-scroll lg:w-3/12 lg:max-w-[23rem] lg:overflow-y-visible lg:shrink-0 lg:sticky lg:top-[5.5rem]" id="sideNav">
      <button class="lg:hidden absolute right-4 top-4 text-3xl text-white" id="sideNavHideButton">
        X
      </button>
      <div class="lg:pt-10 lg:pl-5 xl:pl-20 p-10 pl-20 text-white leading-10 space-y-1 h-full overflow-auto">
  


  
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/trailblazer/index.html">Trailblazer</a>

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/operation/index.html">Operation</a>

        

          

            
              <a href="/2.1/docs/activity/deprecated/index.html" class="" title="Deprecated activity docs: :input/:output, ...">
                
                    <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512" class="fill-grey pl-3 hover:fill-purple flex-inline"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M251.7 127.6l0 0c10.5 10.5 24.7 16.4 39.6 16.4H448c8.8 0 16 7.2 16 16v32H48V96c0-8.8 7.2-16 16-16H197.5c4.2 0 8.3 1.7 11.3 4.7l33.9-33.9L208.8 84.7l42.9 42.9zM48 240H464V416c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V240zM285.7 93.7L242.7 50.7c-12-12-28.3-18.7-45.3-18.7H64C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H291.3c-2.1 0-4.2-.8-5.7-2.3z"/></svg>
                 
              </a>

            


          

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/rails_integration/index.html">Rails integration</a>

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/test/index.html">Test</a>

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col border-t-[1px] border-t-light-purple">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/macro/index.html">Macro</a>

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/workflow/index.html">Workflow</a>

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class="bg-dark-purple flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/endpoint/index.html">Endpoint</a>

        
      </div>


      
        
        <!-- FIXME: link should know its IDs. -->
        <div class="flex items-center" id="left-toc-endpoint-overview">
          <a href="#endpoint-overview" class="pl-8">Overview</a>
        </div>
      
        
        <!-- FIXME: link should know its IDs. -->
        <div class="flex items-center" id="left-toc-endpoint-controller">
          <a href="#endpoint-controller" class="pl-8">Controller</a>
        </div>
      
        
        <!-- FIXME: link should know its IDs. -->
        <div class="flex items-center" id="left-toc-endpoint-runtime">
          <a href="#endpoint-runtime" class="pl-8">Runtime</a>
        </div>
      
        
        <!-- FIXME: link should know its IDs. -->
        <div class="flex items-center" id="left-toc-endpoint-protocol">
          <a href="#endpoint-protocol" class="pl-8">Protocol</a>
        </div>
      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/internals/index.html">Internals</a>

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col border-t-[1px] border-t-light-purple">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/reform/index.html">Reform</a>

        

          

            

              <a href="/2.1/docs/reform/3.0/index.html" class="">
                <span class="h-5 text-[8pt] py-[3px] px-2 rounded-[8px] ml-3 hover:bg-purple hover:border-purple hover:text-white border border-grey text-grey">
                  3.0
                </span>
              </a>
            


          

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/cells/index.html">Cells</a>

        

          

            

              <a href="/2.1/docs/cells/5.0/index.html" class="">
                <span class="h-5 text-[8pt] py-[3px] px-2 rounded-[8px] ml-3 hover:bg-purple hover:border-purple hover:text-white border border-grey text-grey">
                  5.0
                </span>
              </a>
            


          

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/representable/index.html">Representable</a>

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/disposable/index.html">Disposable</a>

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/roar/index.html">Roar</a>

        
      </div>


      
    </div>

    
  
</div>


    </nav>
    <div class="lg:p-10 pl-8 pr-4 py-10 bg-light-grey grow">
      <h1 class="lg:text-3xl text-2xl text-blue font-bold">
        <span class="py-1 px-3 border border rounded border border-white text-white bg-purple">2.1</span>
        <span class="font-black uppercase header-text">
          Endpoint
        </span>
        Documentation
      </h1>

      <div class="xl:flex xl:gap-0.5 mt-5">
        <div class="max-w-3xl lg:p-8 lg:pb-14 p-4 bg-white text-bg-blue space-y-9" id="documentation">
          
<div class="rounded flex p-4 gap-4 bg-bg-purple-1/50">
  <img src="/assets/info_icon-faf751d86d27155660995d9f129cfd3b63ce05a3a91e1acdda7d214f55bdb347.svg" />
  <div class="space-y-3">
    
<p class="">The stable <code class="text-purple">endpoint</code> gem will be released November 2024.</p>

  </div>
</div>

<p class=""><span class="flex max-w-fit max-h-7 border border-grey uppercase text-grey text-xs pt-1 pb-1 pl-2 pr-2 pr-1 ml-4 rounded">
            <svg class="fill-grey mt-[2px]" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M168.5 72L256 165l87.5-93h-175zM383.9 99.1L311.5 176h129L383.9 99.1zm50 124.9H256 78.1L256 420.3 433.9 224zM71.5 176h129L128.1 99.1 71.5 176zm434.3 40.1l-232 256c-4.5 5-11 7.9-17.8 7.9s-13.2-2.9-17.8-7.9l-232-256c-7.7-8.5-8.3-21.2-1.5-30.4l112-152c4.5-6.1 11.7-9.8 19.3-9.8H376c7.6 0 14.8 3.6 19.3 9.8l112 152c6.8 9.2 6.1 21.9-1.5 30.4z"></path></svg>
            <a href="https://github.com/trailblazer/trailblazer-endpoint/tree/v0.1.0" class="ml-1" title="This feature was introduced in trailblazer-endpoint v0.1.0.">trailblazer-endpoint 0.1.0</a>
          </span></p>

<p class="">Whenever you need an <em>operation “around”</em> your actual business operation, to add authentication, policy checks or more steps before or after your domain code, you want to start using endpoints.</p>

<p class="">Instead of you manually calling operations, endpoints are planned to become the canonical way of invoking operations in controllers, jobs and tests.</p>

<ul class="space-y-2">
  <li class="list-image-disc ml-10">Endpoints provide a simple way of defining possible outcomes of an operation</li>
  <li class="list-image-disc ml-10">They come with a simple runtime API that allows you to provide matchers for each outcome. For example, you can handle a “model not found” outcome generically, but override how a success outcome is handled.</li>
  <li class="list-image-disc ml-10">Endpoints are a much better abstraction to customize how your operations are run, and what gets injected. In current projects, many users override <code class="text-purple">Operation.call_with_public_method</code> to add aliases or tweak standard variables in the ctx. This now becomes nothing but another step in the endpoint, before the domain operation.</li>
</ul>

<h2 id="endpoint-overview" class="text-2xl font-bold text-neutral-500 lg:text-3xl py-2 flex items-center"><span class="header-text">Overview</span></h2>

<p class="">An endpoint is defined per <em>use case</em>, which usually corresponds to a particular controller action and operation. In this example, an <code class="text-purple">Update</code> operation is embraced by its endpoint. You may add arbitrary steps to the endpoint, such as authentication, authorization or data filtering that is unrelated to your business domain.</p>

<p class=""><img class="mt-12 mb-12 mx-auto" src="/assets/endpoint-update-77fb5217bf95f2a5828617e1568281c109b5f1e17a740ad39397daeb044bf7d5.png" /></p>

<p class="">Endpoints define a set of possible outcomes: besides <code class="text-purple">success</code> and <code class="text-purple">failure</code> there might be additional, more fine-grained termini like <code class="text-purple">not_found</code> or even <code class="text-purple">credit_card_invalid</code>. It’s the job of your team to decide which generic, reusable termini to introduce.</p>

<p class="">The key idea is to have specific handlers for all outcomes that you write once, while allowing to override specifc cases. In other words, <code class="text-purple">not_found</code> renders a 404 error automatically, but you deal with <code class="text-purple">success</code> manually.</p>

<h3 id="endpoint-overview-example" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center"><span class="header-text">Example</span></h3>

<p class="">Endpoints and the matcher interface can be used anywhere, in controllers, tests, background jobs, or wherever you need to invoke an operation. This example showcases a typical Rails controllers.</p>

<pre class=""><code class="rounded">class MemosController &lt; ApplicationController
  endpoint Memo::Operation::Create # define endpoint.

  def create
    invoke Memo::Operation::Create do # call the endpoint, use matchers:
      success { |ctx, model:, **| redirect_to memo_path(id: model.id) }
      # failure is inherited
      # not_found is inherited
    end
  end
end
</code></pre>

<p class="">Endpoints (currently!) have to be defined on the controller class level using the <code class="text-purple">::endpoint</code> method. Additional options allow configuring how the operation is wired in the endpoint.</p>

<p class="">Actually calling the endpoint (along with your operation) works via the <code class="text-purple">#invoke</code> instance method, which you typically place in a controller action.</p>

<p class="">The block handed to <code class="text-purple">#invoke</code> is where it gets interesting. The matcher interface allows to provide code blocks to handle different outcomes. However, the beautiful part is that you can inherit generic matchers from the <code class="text-purple">ApplicationController</code> (or wherever you inherit from).</p>

<pre class=""><code class="rounded">class ApplicationController &lt; ActionController::Base
  include Trailblazer::Endpoint::Controller.module
  # ...
  endpoint do
    # ...
    default_matcher do
      {
        failure: -&gt;(ctx, **) { head 401 }, # handles {failure} outcome.
        not_found: -&gt;(ctx, params:, **) do
          render html: "ID #{params[:id]} not found.", status: 404
        end
      }
    end

  end
end
</code></pre>

<p class="">Here, using <code class="text-purple">default_block</code>, generic matchers can be defined, saving you tons of code in the controller, and making nested <code class="text-purple">rescue</code> shenanigans in your application controller unnecessary.</p>

<p class="">The <code class="text-purple">Controller</code> module from the <code class="text-purple">endpoint</code> gem ships with several configuration directives, like what to pass into the <code class="text-purple">ctx</code>, default matchers, or whether or not fast-track termini should be wired to the standard railway termini.</p>

<div class="rounded flex p-4 gap-4 bg-bg-purple-1/50">
  <img src="/assets/info_icon-faf751d86d27155660995d9f129cfd3b63ce05a3a91e1acdda7d214f55bdb347.svg" />
  <div class="space-y-3">
    
<p class="">The <code class="text-purple">endpoint</code> gem can be used in frameworks other than Rails (for instance, Grape). Being the mainstream choice of many, these docs focus on Rails.</p>

  </div>
</div>

<h2 id="endpoint-controller" class="text-2xl font-bold text-neutral-500 lg:text-3xl py-2 flex items-center"><span class="header-text">Controller</span></h2>

<p class="">To use endpoint’s runtime tool <code class="text-purple">#invoke</code> and its configuration directives, include the <code class="text-purple">Controller</code> module in your <code class="text-purple">ApplicationController</code>.</p>

<pre class=""><code class="rounded">class ApplicationController &lt; ActionController::Base
  include Trailblazer::Endpoint::Controller.module
</code></pre>

<p class="">Your controller and all subclasses are now ready to configure and run endpoints. Move all generic, reusable configuration to the uppermost controller - usually that’d be the <code class="text-purple">ApplicationController</code>.</p>

<p class="">The easiest way to configure is using the <code class="text-purple">::endpoint</code> block DSL.</p>

<pre class=""><code class="rounded">
class ApplicationController &lt; ActionController::Base
  include Trailblazer::Endpoint::Controller.module

  endpoint do
    options do
      # ...
    end

    ctx do
      # ...
    end

    default_matcher do
      # ...
    end
  end</code></pre>

<h3 id="endpoint-controller-inheritance" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center"><span class="header-text">Inheritance</span></h3>

<p class="">Per default, all configuration options are inherited, allowing you very lean concrete controllers that only override specific directives.</p>

<pre class=""><code class="rounded">class MemosController &lt; ApplicationController
</code></pre>

<p class="">(We’re planning to allow merging <em>and</em> overriding for each directive.)</p>

<h3 id="endpoint-controller-configuration" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center"><span class="header-text">Configuration</span></h3>

<p class="">Setting default values for endpoints on the controller level can be done in two ways.</p>

<ol>
  <li class="list-image-disc ml-10">The recommended way is to use the configuration DSL provided in the <code class="text-purple">::endpoint</code> block. This section explains each option. Note that <code class="text-purple">::endpoint</code> can also be used without a block, to define individual endpoints.</li>
  <li class="list-image-disc ml-10">Another way would be to <a href="https://github.com/trailblazer/trailblazer-endpoint/blob/1273ddac56dc7c7192540707b3e56712a6830f27/test/controller_test.rb#L290" class="underline text-purple">override particular methods</a> in the controller. This is undocumented and should only be done if you’re using anything else but Rails.</li>
</ol>

<h4 id="endpoint-controller-configuration-overview" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Configuration
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium header-text">Overview</span>

                  </h4>

<p class="">Use the <code class="text-purple">::endpoint</code> block DSL on the controller class level to configure how endpoints are built and run.</p>

<pre class=""><code class="rounded">class ApplicationController &lt; ActionController::Base
  # ...
  endpoint do
    options do
      {
        protocol: Endpoint::Protocol,
        # connect fast track outputs to success/failure:
        fast_track_to_railway: true,
      }
    end

    ctx do |controller:, **| # this block is executed in controller instance context.
      {
        params:       controller.params,
        current_user: controller.current_user,
      }
    end

    flow_options do |controller:, activity:, **|
      {
        context_options: {
          aliases: {"contract.default": :contract},
          container_class: Trailblazer::Context::Container::WithAliases,
        }
      }
    end

    default_matcher do
      {
        failure: -&gt;(ctx, **) { head 401 }, # handles {failure} outcome.
        not_found: -&gt;(ctx, params:, **) do
          render html: "ID #{params[:id]} not found.", status: 404
        end
      }
    end

  end
  # ...
end
</code></pre>

<p class="">Available options are explained in the following sections.</p>

<h4 id="endpoint-controller-configuration-default_matcher" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Configuration
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium header-text">default_matcher</span>

                  </h4>

<p class="">You can keep controller actions very lean by defining generic handlers once, on the <code class="text-purple">ApplicationController</code> level using the <code class="text-purple">default_matcher</code> block.</p>

<pre class=""><code class="rounded">endpoint do
  # ...
  default_matcher do
    {
      failure: -&gt;(ctx, **) { head 401 }, # handles {failure} outcome.
      not_found: -&gt;(ctx, params:, **) do
        render html: "ID #{params[:id]} not found.", status: 404
      end
    }
  end
  # ...
end
</code></pre>

<p class="">The returned hash may provide matchers for any possible outcome.</p>

<p class="">The blocks receive the <code class="text-purple">ctx</code> after your endpoint is run, along with keyword arguments, exactly what you’re used to from operation steps. Note that the block is executed in the controller context, allowing to use its API, e.g. <code class="text-purple">#render</code> or <code class="text-purple">#head</code>.</p>

<p class="">You can override specific handlers in controller actions.</p>

<h4 id="endpoint-controller-configuration-options" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Configuration
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium header-text">options</span>

                  </h4>

<p class="">The compilation of your controller’s endpoints can be configured using <code class="text-purple">options</code>.</p>

<pre class=""><code class="rounded">endpoint do
  # ...
  options do
    {
      protocol: Endpoint::Protocol,
      # connect fast track outputs to success/failure:
      fast_track_to_railway: true,
    }
  end
  # ...
end
</code></pre>

<p class="">Make sure you provide a <code class="text-purple">:protocol</code> as this is the only requirement in this directive. # TODO: link to protocol.</p>

<h4 id="endpoint-controller-configuration-fast_track_to_railway" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Configuration
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium header-text">fast_track_to_railway</span>

                  </h4>

<p class="">If you’re not interested in handling your operation’s <code class="text-purple">pass_fast</code> and <code class="text-purple">fail_fast</code> termination separately, you can use the <code class="text-purple">:fast_track_to_railway</code> shortcut in <code class="text-purple">options</code> to wire the two fast track termini to their railway friends.</p>

<pre class=""><code class="rounded">endpoint do
  # ...
  options do
    {
      # ...
      # connect fast track outputs to success/failure:
      fast_track_to_railway: true,
    }
  end
  # ...
end
</code></pre>

<p class="">This will result in a flow diagram similar to this.</p>

<p class=""><img class="mt-12 mb-12 mx-auto" src="/assets/endpoint-fast-track-rw-661befbfd6d9bf5848cd872201683e138ea0a29b402dc8eda1d444576ebe435d.png" /></p>

<p class="">Here, the distinction between <code class="text-purple">failure</code> and <code class="text-purple">fail_fast</code> gets lost after the endpoint has been run. In most scenarios, this is desired, as this mimics querying the result object via <code class="text-purple">result.success?</code>.</p>

<p class="">However, in some cases, you might want to deal with a <code class="text-purple">fail_fast</code> or <code class="text-purple">pass_fast</code> termination of your operation. Simply override it when defining the specific endpoint.</p>

<pre class=""><code class="rounded">class MemosController &lt; ApplicationController
  # ...
  endpoint Memo::Operation::Create, fast_track_to_railway: false
  # ...
end
</code></pre>

<p class="">Your endpoint now needs to define those two additional termini, so they can be properly connected.</p>

<h4 id="endpoint-controller-configuration-ctx" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Configuration
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium header-text">ctx</span>

                  </h4>

<p class="">Use the <code class="text-purple">ctx</code> block to define what ctx variables to pass into the endpoint (and operation) invocation by default.</p>

<pre class=""><code class="rounded">endpoint do
  # ...
  ctx do |controller:, **| # this block is executed in controller instance context.
    {
      params:       controller.params,
      current_user: controller.current_user,
    }
  end
  # ...
end
</code></pre>

<p class="">The block is executed in controller instance context and allows you to access the environment you have within a controller action, e.g. <code class="text-purple">params</code> or <code class="text-purple">request</code>.</p>

<p class="">You can override this directive per controller (on the class level), or add variables in the controller action <a href="#endpoint-runtime-invoke" class="underline text-purple">via <code class="text-purple">#invoke</code></a>.</p>

<h4 id="endpoint-controller-configuration-protocol_block" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Configuration
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium header-text">protocol_block</span>

                  </h4>

<p class="">It is possible to set a default wiring for your domain operations in their endpoint using the <code class="text-purple">:protocol_block</code>. The following example connects the <code class="text-purple">not_found</code> terminus to the endpoint’s <code class="text-purple">not_found</code> track. As this is not a standard railway/fast-track terminus, it’s not wired automatically.</p>

<pre class=""><code class="rounded">class ApplicationController &lt; ActionController::Base
    # ...
    options do
      {
        # ...
        fast_track_to_railway: true, # FIXME: test this!
        # default wiring, applied to all endpoints:
        protocol_block: -&gt; do
          {Output(:not_found) =&gt; End(:not_found)}
        end
      }
    end
    # ...
end
</code></pre>

<p class="">The block simply needs to return a hash that contains <a href="/2.1/docs/operation/index.html#operation-wiring-api" class="underline text-purple">Wiring API</a> instructions. Here is the resulting diagram of that endpoint part.</p>

<p class=""><img class="mt-12 mb-12 mx-auto" src="/assets/endpoint-protocol-block-8fa825071f730269bad543527fe874d8223c76b67a7c79219c0ff15fc88adc9f.png" /></p>

<p class="">Keep in mind, though, that this wiring is applied to all operations in this controller. If a particular operation doesn’t expose a <code class="text-purple">not_found</code> output, this will raise an exception!</p>

<pre class=""><code class="rounded">
`No "not_found" output found for :domain_activity`...</code></pre>

<p class="">In this case, <a href="#endpoint-controller-endpoint-wiring" class="underline text-purple">override the wiring</a> for the respective endpoint.</p>

<p class="">Alternatively, you may use conditional code leveraging the operation’s introspection API. The <code class="text-purple">protocol_block</code> is executed in the respective operation context each time you’re adding a concrete endpoint.</p>

<pre class=""><code class="rounded">class ApplicationController &lt; ActionController::Base
  # ...
  endpoint do
    options do
      {
        # ...
        # default wiring, applied to all endpoints:
        protocol_block: -&gt; do
          if to_h[:outputs].find { |output| output.semantic == :not_found }
            {Output(:not_found) =&gt; End(:not_found)}
          else
            {}
          end
        end
      }
    end
    # ...
  end
  # ...
end
</code></pre>

<h4 id="endpoint-controller-configuration-flow_options" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Configuration
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium header-text">flow_options</span>

                  </h4>

<p class="">You can set <code class="text-purple">flow_options</code> that are injected into the endpoint (or operation) invocation using the same-named block. This is where you would set ctx aliases, for instance.</p>

<pre class=""><code class="rounded">endpoint do
  # ...
  flow_options do |controller:, activity:, **|
    {
      context_options: {
        aliases: {"contract.default": :contract},
        container_class: Trailblazer::Context::Container::WithAliases,
      }
    }
  end
  # ...
end
</code></pre>

<h3 id="endpoint-controller-endpoint" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center"><span class="header-text">Endpoint</span></h3>

<p class="">While the <a href="#endpoint-controller-configuration" class="underline text-purple">block version of <code class="text-purple">::endpoint</code></a> allows to configure the build process and some runtime variables, most of the time you will be using this method to define endpoints per controller action in a concrete controller.</p>

<pre class=""><code class="rounded">class MemosController &lt; ApplicationController
  # ...
  endpoint Memo::Operation::Create # define endpoint.
  # ...
end
</code></pre>

<p class="">This will, at compile time, build and store a dedicated endpoint for your <code class="text-purple">Memo::Operation::Create</code> operation. You can now use that endpoint in your controller actions using <code class="text-purple">#invoke</code>.</p>

<div class="rounded flex p-4 gap-4 bg-bg-purple-1/50">
  <img src="/assets/info_icon-faf751d86d27155660995d9f129cfd3b63ce05a3a91e1acdda7d214f55bdb347.svg" />
  <div class="space-y-3">
    
<p class="">Currently, this is a required step, as compiling an endpoint takes time and technically only has to be done once - at compile time.</p>

<p class="">However, we might come up with a solution that makes defining endpoints redundant in the future.</p>

  </div>
</div>

<h4 id="endpoint-controller-endpoint-wiring" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Endpoint
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium header-text">Wiring</span>

                  </h4>

<p class="">You may add arbitrary wiring for your operation when defining the concrete endpoint. This is done by passing a block after the endpoint’s constant.</p>

<pre class=""><code class="rounded">class MemosController &lt; ApplicationController
  # ...
  endpoint Memo::Operation::Update do
    {
      Output(:not_found) =&gt; End(:failure)
    }
  end
  # ...
end
</code></pre>

<p class="">This wiring block will override any <code class="text-purple">:protocol_block</code> in an inherited controller.</p>

<p class="">Keep in mind that you can also “turn off” the wiring from a super-controller by returning an empty hash.</p>

<pre class=""><code class="rounded">endpoint Memo::Operation::Create do
  {} # override ApplicationController's wiring.
end
</code></pre>

<h4 id="endpoint-controller-endpoint-name" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Endpoint
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium header-text">Name</span>

                  </h4>

<p class="">If you need one distinct operation in several endpoints, pass a name instead of the class.</p>

<pre class=""><code class="rounded">class MemosController &lt; ApplicationController
  # ...
  endpoint "create", domain_activity: Memo::Operation::Create
  endpoint "create/admin",
    domain_activity: Memo::Operation::Create,
    protocol: Protocol::Admin
  # ...
end
</code></pre>

<p class="">The actual operation to be embedded in the endpoint is specified via <code class="text-purple">:domain_activity</code>. Note that you may pass additional build options here.</p>

<p class="">In the controller action, you now need to pass the <em>name</em> to <code class="text-purple">#invoke</code>.</p>

<pre class=""><code class="rounded">class MemosController &lt; ApplicationController
  # ...
  def create
    invoke "create" do # endpoint name
      # ...
    end
  end
  # ...
end
</code></pre>

<h2 id="endpoint-runtime" class="text-2xl font-bold text-neutral-500 lg:text-3xl py-2 flex items-center"><span class="header-text">Runtime</span></h2>

<p class="">The real fun starts when using endpoints in a controller action. This is when the endpoint and your business logic is executed and the respective matcher is run.</p>

<h3 id="endpoint-runtime-invoke" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center"><span class="header-text">Invoke</span></h3>

<p class="">You can invoke the controller’s endpoints using <code class="text-purple">#invoke</code>. Just pass the endpoint’s name, which is usually the class constant.</p>

<pre class=""><code class="rounded">class MemosController &lt; ApplicationController
  # ...
  def create
    invoke Memo::Operation::Create do # call the endpoint, use matchers:
      success { |ctx, model:, **| redirect_to memo_path(id: model.id) }
      # failure is inherited
      # not_found is inherited
    end
  end
  # ...
end
</code></pre>

<p class="">This will run the endpoint, along with your embedded domain operation. Using the matcher block, you can override specific handlers ad-hoc, in case the inherited default matchers don’t suit the controller action.</p>

<h4 id="endpoint-runtime-invoke-variables" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Invoke
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium header-text">Variables</span>

                  </h4>

<p class="">Keep in mind that, per default, only the variables configured in the <a href="/2.1/docs/endpoint/index.html#endpoint-controller-configuration-ctx" class="underline text-purple"><code class="text-purple">ctx {}</code> block</a> are passed into the endpoint, and the operation.</p>

<pre class=""><code class="rounded">endpoint do
  # ...
  ctx do |controller:, **| # this block is executed in controller instance context.
    {
      params:       controller.params,
      current_user: controller.current_user,
    }
  end
  # ...
end
</code></pre>

<p class="">In the operation, you will only see the variables configured above.</p>

<pre class=""><code class="rounded">module Memo::Operation
  class Update &lt; Trailblazer::Operation
    step :find_model
    # ...
    def find_model(ctx, **)
      p ctx.keys.inspect # =&gt; [:params, :current_user]
    end
  end
end
</code></pre>

<p class="">If you need additional variables, simply pass them to <code class="text-purple">#invoke</code>.</p>

<pre class=""><code class="rounded">class MemosController &lt; ApplicationController
  # ...
  def update_with_runtime_variables
    invoke Memo::Operation::Update, storage: MyBucket do
      # ...
    end
  end
  # ...
end
</code></pre>

<p class="">Your operation can now see the <code class="text-purple">:storage</code> variable, too.</p>

<pre class=""><code class="rounded">def find_model(ctx, **)
  p ctx.keys.inspect # =&gt; [:params, :current_user, :storage]
end
</code></pre>

<p class="">Variables handed to <code class="text-purple">#invoke</code> will override default variables from the <a href="/2.1/docs/endpoint/index.html#endpoint-controller-configuration-ctx" class="underline text-purple"><code class="text-purple">ctx {}</code> block</a>.</p>

<h3 id="endpoint-runtime-no-protocol" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center"><span class="header-text">No protocol</span></h3>

<h2 id="endpoint-protocol" class="text-2xl font-bold text-neutral-500 lg:text-3xl py-2 flex items-center"><span class="header-text">Protocol</span></h2>

<p class="">Inheritance</p>

<!--
As visible in this illustreous diagram, invoking an endpoint usually involves two steps.

1. Running authentication and authorization, allowing to move this logic from the controller's `before_filter`s to a traceable activity.
2. Running the actual domain code, your `Update` operation.

The key of the endpoint is to specify generic outcomes to be reused across the entire application: `not_found` or `not_authorized` are well-defined outcomes that can now be handled by generic code you write once.


<div class="rounded flex p-4 gap-4 bg-bg-purple-1/50">
  <img src="/assets/info_icon-faf751d86d27155660995d9f129cfd3b63ce05a3a91e1acdda7d214f55bdb347.svg" />
  <div class="space-y-3">
    
<p class="">Letting the endpoint handle the authentication, policy checks and more is completely up to you. If desired, or during a refactoring, leave this code in your <code class="text-purple">before_filter</code>s.</p>

  </div>
</div>






Endpoints will be the canonical, recommended way to running operations.

 -->

        </div>

            <!-- 5.5rem is lg navbar height -->
        <div class="bg-white h-screen w-56 sticky top-[5.5rem]" id="right-toc">
          <div id="docsearch" class="flex flex-col w-[203px] pt-5"></div>

          <div class="display_none bg-white p-5 w-56 shrink-0 text-bg-blue overflow-y-scroll top-22" id="right-toc-endpoint-overview">
  <h4 class="font-base font-bold leading-10 pl-2">
     Overview
  </h4>

  
    <a class="block px-2 leading-8" href="#endpoint-overview-example">Example</a>

    
  
</div>


<div class="display_none bg-white p-5 w-56 shrink-0 text-bg-blue overflow-y-scroll top-22" id="right-toc-endpoint-controller">
  <h4 class="font-base font-bold leading-10 pl-2">
     Controller
  </h4>

  
    <a class="block px-2 leading-8" href="#endpoint-controller-inheritance">Inheritance</a>

    
  
    <a class="block px-2 leading-8" href="#endpoint-controller-configuration">Configuration</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#endpoint-controller-configuration-overview">Overview</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#endpoint-controller-configuration-default_matcher">default_matcher</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#endpoint-controller-configuration-options">options</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#endpoint-controller-configuration-fast_track_to_railway">fast_track_to_railway</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#endpoint-controller-configuration-ctx">ctx</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#endpoint-controller-configuration-protocol_block">protocol_block</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#endpoint-controller-configuration-flow_options">flow_options</a>
    
  
    <a class="block px-2 leading-8" href="#endpoint-controller-endpoint">Endpoint</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#endpoint-controller-endpoint-wiring">Wiring</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#endpoint-controller-endpoint-name">Name</a>
    
  
</div>


<div class="display_none bg-white p-5 w-56 shrink-0 text-bg-blue overflow-y-scroll top-22" id="right-toc-endpoint-runtime">
  <h4 class="font-base font-bold leading-10 pl-2">
     Runtime
  </h4>

  
    <a class="block px-2 leading-8" href="#endpoint-runtime-invoke">Invoke</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#endpoint-runtime-invoke-variables">Variables</a>
    
  
    <a class="block px-2 leading-8" href="#endpoint-runtime-no-protocol">No protocol</a>

    
  
</div>


<div class="display_none bg-white p-5 w-56 shrink-0 text-bg-blue overflow-y-scroll top-22" id="right-toc-endpoint-protocol">
  <h4 class="font-base font-bold leading-10 pl-2">
     Protocol
  </h4>

  
</div>


        </div>
      </div>
    </div>
  </div>
</section>


<footer class="lg:text-left bg-bg-blue py-16 text-white text-center text-base">
  <div class="lg:flex justify-between w-11/12 max-w-[80rem] mx-auto">
    <div class="lg:flex lg:flex-col lg:justify-between">
      <a href="/2.1/" class="block shrink-0 w-fit mx-auto lg:mx-0" >
        <img class="w-48" src="/assets/logo_white_ruby-01c45713d0879788514c52d65ac53e92d7735b42cec0baf6e080b08f9a0fb595.svg" />
      </a>
      <div class="lg:block hidden">
        © 2023 Trailblazer GmbH

      </div>
    </div>
    <div class="lg:flex lg:gap-20 xl:gap-40">
      <div class="lg:mt-0 flex flex-col gap-5 mt-15">
        <a class="font-bold text-xl" href="/2.1/docs/trailblazer/">Documentation</a>
        <a href="/2.1/docs/trailblazer/#trailblazer-learn-trailblazer-tales">Videos</a>
        <a href="/2.1/docs/trailblazer/">API</a>
        <a href="/2.1/docs/operation/">Operation</a>
      </div>
      <div class="lg:mt-0 flex flex-col gap-5 mt-15">
        <a class="font-bold text-xl" href="/2.1/about/">About us</a>
        <div class="flex items-center">
          <a href="https://www.linkedin.com/company/trailblazer-gmbh/">LinkedIn</a>
          <a href="https://www.linkedin.com/company/trailblazer-gmbh/">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="fill-white pl-2" height="1.3em"><!--!Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
          </a>
        </div>
        <a href="https://dev.to/trailblazer">Blog</a>
        <a href="/2.1/about/">Trailblazer GmbH</a>
        <a href="/2.1/pro/">Trailblazer PRO</a>
      </div>
      <div class="lg:mt-0 flex flex-col gap-5 mt-15">
        <a class="font-bold text-xl" href="https://trailblazer.zulipchat.com">Help</a>
        <a href="https://trailblazer.zulipchat.com">Chat</a>
        <a href="http://eepurl.com/hHE3a5">Newsletter</a>
      </div>
    </div>
  </div>
  <div class="lg:hidden mt-15">
    © 2023 Trailblazer GmbH
  </div>
</footer>


  </body>
</html>
